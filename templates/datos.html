{% extends "layout.html" %}

{% block title %}Formulario{% endblock %}

{% block content %}
    <h1>Parametros Ficha Tecnica</h1>
    <form method="post">
        <label for="lote">Lote:</label>
        <select id="lote" name="lote" required>
            <option value="">Seleccionar Lote</option>
        </select><br><br>

        <!-- Nuevo selector de Turno -->
        <label for="turno">Turno:</label>
        <select id="turno" name="turno" disabled required>
            <option value="">Seleccionar Turno</option>
        </select><br><br>

        <label for="valvula">Válvula:</label>
        <select id="valvula" name="valvula" disabled required>
            <option value="">Seleccionar Válvula</option>
        </select><br><br>

        <label for="area">Área:</label>
        <select id="area" name="area" disabled required>
           <option value="">Seleccionar Área</option>
        </select><br><br>

        <label for="ciclo">Ciclo:</label>
        <input type="number" id="ciclo" name="ciclo" step="1" required><br><br>

        <label for="edad">Edad:</label>
        <input type="number" id="edad" name="edad" step="any" required><br><br>

        <label for="muestra">Muestra:</label>
        <input type="number" id="muestra" name="muestra" step="1"><br><br>

        <label for="tamano">Tamaño Muestra "mts":</label>
        <input type="number" id="tamano" name="tamano" step="any"><br><br>

        <label for="hojas">Hojas/Dia:</label>
        <input type="number" id="hojas" name="hojas" step="1"><br><br>

        <label for="guias">Número de Guias:</label>
        <input type="number" id="guias" name="guias" step="1"><br><br>

        <label for="entrenudo">Entrenudos cm:</label>
        <input type="number" id="entrenudo" name="entrenudo" step="1"><br><br>

        <label for="tensiometroa">Tensiometro 12:</label>
        <input type="number" id="tensiometroa" name="tensiometroa" step="any"><br><br>

        <label for="tensiometrob">Tensiometro 24:</label>
        <input type="number" id="tensiometrob" name="tensiometrob" step="any"><br><br>

        <label for="observaciones">Observaciones:</label><br>
        <textarea id="observaciones" name="observaciones" rows="4" cols="50"></textarea><br><br>

        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">

        <input type="submit" value="Guardar Datos">
    </form>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loteSelect = document.getElementById('lote');
            const turnoSelect = document.getElementById('turno');
            const valvulaSelect = document.getElementById('valvula');
            const areaSelect = document.getElementById('area');

            // Función para cargar opciones en un select
            const loadOptions = (selectElement, data, defaultMessage) => {
                selectElement.innerHTML = `<option value="">${defaultMessage}</option>`;
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.toString();  // Asegúrate de convertir todo a string
                    option.textContent = item.toString();  // Convierte los números a string
                    selectElement.appendChild(option);
                });
            };

            // Cargar lotes
            fetch('/api/lotes')
                .then(response => response.json())
                .then(data => {
                    loadOptions(loteSelect, data, 'Seleccionar Lote');
                });

            loteSelect.addEventListener('change', () => {
                const lote = loteSelect.value;
                if (lote) {
                    fetch(`/api/turnos?lote=${lote}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("Turnos recibidos:", data);  // Depuración
                            loadOptions(turnoSelect, data, 'Seleccionar Turno');
                            turnoSelect.disabled = false;
                            areaSelect.innerHTML = '<option value="">Seleccionar Área</option>'; // Reset area
                            areaSelect.disabled = true; // Disable area initially
                            valvulaSelect.innerHTML = '<option value="">Seleccionar Válvula</option>'; // Reset valvula
                            valvulaSelect.disabled = true; // Disable valvula
                        });
                } else {
                    loadOptions(turnoSelect, [], 'Seleccionar Turno');
                    turnoSelect.disabled = true;
                    loadOptions(valvulaSelect, [], 'Seleccionar Válvula');
                    valvulaSelect.disabled = true;
                    loadOptions(areaSelect, [], 'Seleccionar Área');
                    areaSelect.disabled = true; // Disable area
                }
            });

            turnoSelect.addEventListener('change', () => {
                const lote = loteSelect.value;
                const turno = turnoSelect.value;
                if (lote && turno) {
                    // Cargar válvulas
                    fetch(`/api/valvulas?lote=${lote}&turno=${turno}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("Válvulas recibidas:", data);  // Depuración
                            loadOptions(valvulaSelect, data, 'Seleccionar Válvula');
                            valvulaSelect.disabled = false;

                            // Cargar áreas
                            fetch(`/api/areas?lote=${lote}&turno=${turno}`)
                                .then(response => response.json())
                                .then(data => {
                                    console.log("Áreas recibidas:", data);  // Depuración
                                    loadOptions(areaSelect, data, 'Seleccionar Área');
                                    areaSelect.disabled = false; // Habilitar área
                                })
                                .catch(error => console.error("Error cargando áreas:", error)); // Captura errores
                        })
                        .catch(error => console.error("Error cargando válvulas:", error)); // Captura errores
                } else {
                    loadOptions(valvulaSelect, [], 'Seleccionar Válvula');
                    valvulaSelect.disabled = true;
                    loadOptions(areaSelect, [], 'Seleccionar Área');
                    areaSelect.disabled = true; // Disable area
                }
            });
        });
    </script>
{% endblock %}
