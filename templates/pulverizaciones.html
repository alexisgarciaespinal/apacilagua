{% extends "layout.html" %}

{% block title %}Formulario{% endblock %}

{% block content %}
    <h1 style="color: #02943a; font-size: 24px; font-weight: bold;">Pulverizaciones</h1>
    <form method="post">
        <label for="lote" style="color: rgb(14, 5, 5); font-weight: bold; padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Lote:</label>
        <select id="lote" name="lote" required>
            <option value="">Seleccionar Lote</option>
        </select><br><br>

        <!-- Nuevo selector de Turno -->
        <label for="turno" style="color: rgb(14, 5, 5); font-weight: bold; padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Turno:</label>
        <select id="turno" name="turno" disabled required>
            <option value="">Seleccionar Turno</option>
        </select><br><br>

        <label for="valvula" style="color: rgb(14, 5, 5); font-weight: bold; padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Válvula:</label>
        <select id="valvula" name="valvula" disabled required>
            <option value="">Seleccionar Válvula</option>
        </select><br><br>

        <label for="area" style="color: rgb(14, 5, 5); font-weight: bold; padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Área:</label>
        <select id="area" name="area" disabled required>
           <option value="">Seleccionar Área</option>
        </select><br><br>

        <label for="ciclo" style="color: rgb(14, 5, 5); font-weight: bold; padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Ciclo:</label>
        <select id="ciclo" name="ciclo" required>
            <option value="">Seleccionar Ciclo</option>
            {% for ciclo in ciclos %}
                <option value="{{ ciclo }}">{{ ciclo }}</option>
            {% endfor %}
        </select><br><br>

        <!-- Reemplazar input de variedad por un select -->
        <label for="variedad" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(243, 243, 239); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Variedad:</label>
        <select id="variedad" name="variedad" required>
            <option value="">Seleccionar Variedad</option>
            <!-- Aquí se insertan las variedades desde la base de datos -->
            {% for variedad in variedades %}
                <option value="{{ variedad }}">{{ variedad }}</option>
            {% endfor %}
        </select><br><br>
        
        <label for="edad" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Edad:</label>
        <input type="number" id="edad" name="edad" step="any" required><br><br>

        <label for="bonada" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Numero de Bonada:</label>
        <input type="number" id="bonada" name="bonada" step="1"><br><br> <!-- le quite para que no sea obligatorio -->

        <label for="equipo" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Equipo Aplicacion:</label>
        <input type="text" id="equipo" name="equipo" step="any"><br><br>

        <label for="operario" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Operario:</label>
        <input type="text" id="operario" name="operario" step="any"><br><br>

        <label for="producto1" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Producto 1:</label>
        <input type="text" id="producto1" name="producto1" step="any"><br><br>

        <label for="producto2" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Producto 2:</label>
        <input type="text" id="producto2" name="producto2" step="any"><br><br>

        <label for="producto3" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Producto 3:</label>
        <input type="text" id="producto3" name="producto3" step="any"><br><br>

        <label for="producto4" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Producto 4:</label>
        <input type="text" id="producto4" name="producto4" step="any"><br><br>

        <label for="producto5" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Producto 5:</label>
        <input type="text" id="producto5" name="producto5" step="any"><br><br>

        <label for="ce" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">CE ms:</label>
        <input type="number" id="ce" name="ce" step="0.01"><br><br>

        <label for="ph" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">PH:</label>
        <input type="number" id="ph" name="ph" step="0.01"><br><br>

        <label for="temperatura" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Temperatura °C:</label>
        <input type="number" id="temperatura" name="temperatura" step="0.01"><br><br>

        <label for="velocidad" style="color: rgb(14, 5, 5); font-weight: bold; background-color: rgb(116, 190, 106); padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Velocidad Viento km/hr:</label>
        <input type="number" id="velocidad" name="velocidad" step="0.01"><br><br>

        <label for="observaciones" style="color: rgb(14, 5, 5); font-weight: bold; padding: 5px; border-radius: 5px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">Observaciones:</label><br>
        <textarea id="observaciones" name="observaciones" rows="4" cols="50"></textarea><br><br>

        <!-- Campos ocultos para las coordenadas -->
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">

        <input type="submit" value="Guardar Datos">
    </form>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    const loteSelect = document.getElementById('lote');
    const turnoSelect = document.getElementById('turno');
    const valvulaSelect = document.getElementById('valvula');
    const areaSelect = document.getElementById('area');

    // Función para cargar opciones en un select
    const loadOptions = (selectElement, data, defaultMessage) => {
        selectElement.innerHTML = `<option value="">${defaultMessage}</option>`; // Agregar mensaje por defecto
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.toString();  // Convertir a string para evitar errores
            option.textContent = item.toString();  // Asegúrate de mostrar el texto correcto
            selectElement.appendChild(option);
        });
    };

    // Cargar lotes al iniciar la página
    fetch('/api/lotes')
        .then(response => response.json())
        .then(data => {
            loadOptions(loteSelect, data, 'Seleccionar Lote');
        });

    // Evento para manejar cambio en el select de lote
    loteSelect.addEventListener('change', () => {
        const lote = loteSelect.value;
        if (lote) {
            fetch(`/api/turnos?lote=${lote}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Turnos recibidos:", data);  // Depuración
                    loadOptions(turnoSelect, data, 'Seleccionar Turno');
                    turnoSelect.disabled = false;
                    areaSelect.innerHTML = '<option value="">Seleccionar Área</option>'; // Resetear área
                    areaSelect.disabled = true; // Deshabilitar área inicialmente
                    valvulaSelect.innerHTML = '<option value="">Seleccionar Válvula</option>'; // Resetear válvula
                    valvulaSelect.disabled = true; // Deshabilitar válvula
                });
        } else {
            loadOptions(turnoSelect, [], 'Seleccionar Turno');
            turnoSelect.disabled = true;
            loadOptions(valvulaSelect, [], 'Seleccionar Válvula');
            valvulaSelect.disabled = true;
            loadOptions(areaSelect, [], 'Seleccionar Área');
            areaSelect.disabled = true;
        }
    });

    // Evento para manejar cambio en el select de turno
    turnoSelect.addEventListener('change', () => {
        const lote = loteSelect.value;
        const turno = turnoSelect.value;
        if (lote && turno) {
            // Cargar válvulas
            fetch(`/api/valvulas?lote=${lote}&turno=${turno}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Válvulas recibidas:", data);  // Depuración
                    loadOptions(valvulaSelect, data, 'Seleccionar Válvula');
                    valvulaSelect.disabled = false;

                    // Cargar áreas
                    fetch(`/api/areas?lote=${lote}&turno=${turno}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("Áreas recibidas:", data);  // Depuración
                            // Extraer la propiedad 'Area_mz' de cada objeto 'Area'
                            const areaNames = data.map(area => area.Area_mz); // Usar 'Area_mz' en lugar de 'nombre'
                            loadOptions(areaSelect, areaNames, 'Seleccionar Área');
                            areaSelect.disabled = false; // Habilitar área
                        })
                        .catch(error => console.error("Error cargando áreas:", error)); // Captura errores
                })
                .catch(error => console.error("Error cargando válvulas:", error)); // Captura errores
        } else {
            loadOptions(valvulaSelect, [], 'Seleccionar Válvula');
            valvulaSelect.disabled = true;
            loadOptions(areaSelect, [], 'Seleccionar Área');
            areaSelect.disabled = true;
        }
    });

    // Evento para manejar cambio en el select de válvula
    valvulaSelect.addEventListener('change', () => {
        const lote = loteSelect.value;
        const turno = turnoSelect.value;
        const valvula = valvulaSelect.value;

        if (lote && turno && valvula) {
            // Hacer una llamada para obtener el área correspondiente
            fetch(`/api/area?lote=${lote}&turno=${turno}&valvula=${valvula}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la solicitud: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Áreas filtradas recibidas:", data);  // Depuración
                    // Extraer la propiedad 'Area_mz' del área filtrada
                    const areaNames = data.map(area => area.Area_mz); // Usar 'Area_mz' en lugar de 'nombre'
                    loadOptions(areaSelect, areaNames, 'Seleccionar Área');
                    areaSelect.disabled = false; // Habilitar área
                })
                .catch(error => console.error("Error cargando área:", error)); // Captura errores
        } else {
            loadOptions(areaSelect, [], 'Seleccionar Área');
            areaSelect.disabled = true;
        }
    });
});

    </script>
{% endblock %}


