{% extends "layout.html" %}

{% block title %}Formulario{% endblock %}

{% block content %}
    <h1>Estimaciones</h1>
    <form method="post">
        <label for="lote">Lote:</label>
        <select id="lote" name="lote" required>
            <option value="">Seleccionar Lote</option>
        </select><br><br>

        <!-- Nuevo selector de Turno -->
        <label for="turno">Turno:</label>
        <select id="turno" name="turno" disabled required>
            <option value="">Seleccionar Turno</option>
        </select><br><br>

        <label for="valvula">Válvula:</label>
        <select id="valvula" name="valvula" disabled required>
            <option value="">Seleccionar Válvula</option>
        </select><br><br>

        <label for="area">Área:</label>
        <select id="area" name="area" disabled required>
           <option value="">Seleccionar Área</option>
        </select><br><br>

        <label for="ciclo">Ciclo:</label>
        <input type="number" id="ciclo" name="ciclo" step="1" required><br><br>

        <label for="variedad">Variedad:</label>
        <input type="text" id="labor" name="variedad" required><br><br>
        
        <label for="edad">Edad:</label>
        <input type="number" id="edad" name="edad" step="any" required><br><br>

        <label for="muestra">Muestra:</label>
        <input type="number" id="muestra" name="muestra" step="1"><br><br> <!-- le quite para que no sea obligatorio -->

        <label for="tamano">Tamaño Muestra "mts":</label>
        <input type="number" id="tamano" name="tamano" step="any"><br><br>

        <label for="floresf">Flores Femeninas:</label>
        <input type="number" id="floresf" name="floresf" step="1"><br><br>

        <label for="floresm">Flores Masculinas:</label>
        <input type="number" id="floresm" name="floresm" step="1"><br><br>

        <label for="pegafruto">Pega de Frutos:</label>
        <input type="number" id="pegafruto" name="pegafruto" step="1" min="0"><br><br>

        <label for="curva_crecimiento">Crecimiento cms:</label>
        <input type="number" id="curva_crecimiento" name="curva_crecimiento" step="any"><br><br>

        <label for="planta_pegada">Plantas Pegadas:</label>
        <input type="number" id="planta_pegada" name="planta_pegada" step="any"><br><br>

        <label for="total_plantas">Total de Plantas:</label>
        <input type="number" id="total_plantas" name="total_plantas" step="any"><br><br>

        <label for="observaciones">Observaciones:</label><br>
        <textarea id="observaciones" name="observaciones" rows="4" cols="50"></textarea><br><br>

        <!-- Campos ocultos para las coordenadas -->
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">

        <input type="submit" value="Guardar Datos">
    </form>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    const loteSelect = document.getElementById('lote');
    const turnoSelect = document.getElementById('turno');
    const valvulaSelect = document.getElementById('valvula');
    const areaSelect = document.getElementById('area');

    // Función para cargar opciones en un select
    const loadOptions = (selectElement, data, defaultMessage) => {
        selectElement.innerHTML = `<option value="">${defaultMessage}</option>`; // Agregar mensaje por defecto
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.toString();  // Convertir a string para evitar errores
            option.textContent = item.toString();  // Asegúrate de mostrar el texto correcto
            selectElement.appendChild(option);
        });
    };

    // Cargar lotes al iniciar la página
    fetch('/api/lotes')
        .then(response => response.json())
        .then(data => {
            loadOptions(loteSelect, data, 'Seleccionar Lote');
        });

    // Evento para manejar cambio en el select de lote
    loteSelect.addEventListener('change', () => {
        const lote = loteSelect.value;
        if (lote) {
            fetch(`/api/turnos?lote=${lote}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Turnos recibidos:", data);  // Depuración
                    loadOptions(turnoSelect, data, 'Seleccionar Turno');
                    turnoSelect.disabled = false;
                    areaSelect.innerHTML = '<option value="">Seleccionar Área</option>'; // Resetear área
                    areaSelect.disabled = true; // Deshabilitar área inicialmente
                    valvulaSelect.innerHTML = '<option value="">Seleccionar Válvula</option>'; // Resetear válvula
                    valvulaSelect.disabled = true; // Deshabilitar válvula
                });
        } else {
            loadOptions(turnoSelect, [], 'Seleccionar Turno');
            turnoSelect.disabled = true;
            loadOptions(valvulaSelect, [], 'Seleccionar Válvula');
            valvulaSelect.disabled = true;
            loadOptions(areaSelect, [], 'Seleccionar Área');
            areaSelect.disabled = true;
        }
    });

    // Evento para manejar cambio en el select de turno
    turnoSelect.addEventListener('change', () => {
        const lote = loteSelect.value;
        const turno = turnoSelect.value;
        if (lote && turno) {
            // Cargar válvulas
            fetch(`/api/valvulas?lote=${lote}&turno=${turno}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Válvulas recibidas:", data);  // Depuración
                    loadOptions(valvulaSelect, data, 'Seleccionar Válvula');
                    valvulaSelect.disabled = false;

                    // Cargar áreas
                    fetch(`/api/areas?lote=${lote}&turno=${turno}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("Áreas recibidas:", data);  // Depuración
                            // Extraer la propiedad 'Area_mz' de cada objeto 'Area'
                            const areaNames = data.map(area => area.Area_mz); // Usar 'Area_mz' en lugar de 'nombre'
                            loadOptions(areaSelect, areaNames, 'Seleccionar Área');
                            areaSelect.disabled = false; // Habilitar área
                        })
                        .catch(error => console.error("Error cargando áreas:", error)); // Captura errores
                })
                .catch(error => console.error("Error cargando válvulas:", error)); // Captura errores
        } else {
            loadOptions(valvulaSelect, [], 'Seleccionar Válvula');
            valvulaSelect.disabled = true;
            loadOptions(areaSelect, [], 'Seleccionar Área');
            areaSelect.disabled = true;
        }
    });

    // Evento para manejar cambio en el select de válvula
    valvulaSelect.addEventListener('change', () => {
        const lote = loteSelect.value;
        const turno = turnoSelect.value;
        const valvula = valvulaSelect.value;

        if (lote && turno && valvula) {
            // Hacer una llamada para obtener el área correspondiente
            fetch(`/api/area?lote=${lote}&turno=${turno}&valvula=${valvula}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la solicitud: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Áreas filtradas recibidas:", data);  // Depuración
                    // Extraer la propiedad 'Area_mz' del área filtrada
                    const areaNames = data.map(area => area.Area_mz); // Usar 'Area_mz' en lugar de 'nombre'
                    loadOptions(areaSelect, areaNames, 'Seleccionar Área');
                    areaSelect.disabled = false; // Habilitar área
                })
                .catch(error => console.error("Error cargando área:", error)); // Captura errores
        } else {
            loadOptions(areaSelect, [], 'Seleccionar Área');
            areaSelect.disabled = true;
        }
    });
});

    </script>
{% endblock %}


